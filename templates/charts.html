{% extends "base.html" %}
{% set active_page = "charts" %}

{% block title %}Gràfics - La Masia Stats{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-12 text-center">
        <h1 class="display-4 fw-bold mb-3">Gràfics de l'Equip</h1>
        <p class="lead text-secondary">Anàlisi visual de la temporada</p>
    </div>
</div>

<div class="row g-4 mb-5">
    <!-- Points Chart -->
    <div class="col-12">
        <div class="glass-card p-4">
            <h3 class="mb-4">Evolució de Punts (Acumulat)</h3>
            <canvas id="pointsChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <!-- Goals Chart -->
    <div class="col-12">
        <div class="glass-card p-4">
            <h3 class="mb-4">Gols Acumulats (Favor vs Contra)</h3>
            <canvas id="goalsChart" style="max-height: 400px;"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js and Annotation Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<!-- Check if Espanyol exists in the list to determine where to put the line -->
{% set espanyol_index = -1 %}
{% for rival in chart_data['labels'] %}
{% if rival == 'Espanyol' %}
{% set espanyol_index = loop.index0 %}
{% endif %}
{% endfor %}

<script>
    const chartData = {{ chart_data | tojson }};
    const espanyolIndex = {{ espanyol_index }};

    // Setup generic options for dark theme
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

    // --- Points Chart ---
    const ctxPoints = document.getElementById('pointsChart').getContext('2d');

    const annotations = {};
    if (espanyolIndex !== -1) {
        annotations.halfSeasonLine = {
            type: 'line',
            xMin: espanyolIndex + 0.5,
            xMax: espanyolIndex + 0.5,
            borderColor: '#facc15', // Yellow
            borderWidth: 2,
            borderDash: [6, 6],
            label: {
                display: true,
                content: 'Final 1a Volta',
                position: 'start',
                backgroundColor: 'rgba(0,0,0,0.7)',
                color: '#facc15'
            }
        };
    }

    // Map results to colors
    const pointColors = chartData.results.map(result => {
        if (result === 'Victòria') return '#22c55e'; // Green
        if (result === 'Derrota') return '#ef4444'; // Red
        return '#6c757d'; // Grey (Empat)
    });

    new Chart(ctxPoints, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Punts',
                data: chartData.points,
                borderColor: '#3b82f6', // Blue
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 3,
                tension: 0, // Straight lines
                fill: true,
                pointBackgroundColor: pointColors,
                pointBorderColor: pointColors,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                annotation: {
                    annotations: annotations
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: 3,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // --- Goals Chart ---
    const ctxGoals = document.getElementById('goalsChart').getContext('2d');
    new Chart(ctxGoals, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Gols a Favor',
                    data: chartData.goals_for,
                    backgroundColor: 'rgba(34, 197, 94, 0.2)', // Green
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Gols en Contra',
                    data: chartData.goals_against,
                    backgroundColor: 'rgba(239, 68, 68, 0.2)', // Red
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}